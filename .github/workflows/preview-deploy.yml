name: Preview Deploy (PR -> dev)

on:
  pull_request:
    branches: ["dev"]
    types: [opened, synchronize, reopened]

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  deploy_preview:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy PR preview over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script_stop: true
          script: |
            set -euo pipefail
            die() { echo "❌ $1"; exit 1; }
            run() { echo "▶ $*"; "$@"; }
            trap 'rc=$?; if [ $rc -ne 0 ]; then echo "❌ Script exiting with code=$rc at line $LINENO"; fi' EXIT
            trap 'echo "❌ FAIL at line $LINENO: $BASH_COMMAND (exit=$?)"' ERR

            echo "SHELL=$SHELL"
            echo "BASH_VERSION=${BASH_VERSION:-none}"
            echo "0=$0"

            PR_NUMBER="${{ github.event.pull_request.number }}"
            PR_SHA="${{ github.event.pull_request.head.sha }}"

            PREVIEW_BASE_HOST="linuxtest2.woki.co.il"
            PR_PATH="/pr/${PR_NUMBER}"

            APP_DIR="/opt/apps/yardena-previews/pr-${PR_NUMBER}"
            REPO_SSH="git@github.com:ValeryDevWoki/CI-CD_Testing.git"
            PROJECT="yardena-pr-${PR_NUMBER}"

            MAIN_DB_CONTAINER="yardena-db-1"
            PGUSER="yardena"
            PGDATABASE="yardena_test"

            echo "ENV CHECK: PR_NUMBER=$PR_NUMBER PREVIEW_BASE_HOST=$PREVIEW_BASE_HOST PR_PATH=$PR_PATH"
            echo "APP_DIR=$APP_DIR PROJECT=$PROJECT"

            echo "STEP: check docker access"
            docker ps >/dev/null

            echo "STEP: prepare APP_DIR"
            mkdir -p "$APP_DIR"

            if [ ! -d "$APP_DIR/.git" ]; then
              echo "STEP: clone repo"
              git clone "$REPO_SSH" "$APP_DIR"
            fi

            echo "STEP: checkout PR SHA"
            cd "$APP_DIR"
            git fetch --all
            git reset --hard "$PR_SHA"

            # backend.env copy
            if [ ! -f "$APP_DIR/deploy/backend.env" ]; then
              if [ -f "/opt/apps/yardena/deploy/backend.env" ]; then
                cp /opt/apps/yardena/deploy/backend.env "$APP_DIR/deploy/backend.env"
              else
                echo "❌ Missing $APP_DIR/deploy/backend.env and no fallback /opt/apps/yardena/deploy/backend.env" >&2
                exit 1
              fi
            fi

            export PR_NUMBER="$PR_NUMBER"
            export PREVIEW_BASE_HOST="$PREVIEW_BASE_HOST"
            export PR_PATH="$PR_PATH"

            docker network create traefik_preview_public >/dev/null 2>&1 || true

            # ---------------- DB snapshot (on-demand with cache) ----------------
            # store dump cache inside PR directory to avoid permission issues
            DUMP_DIR="$APP_DIR/.cache/db-dumps"
            DUMP="$DUMP_DIR/latest.dump"
            MAX_AGE_MIN=60

            echo "STEP: prepare dump dir: $DUMP_DIR"
            mkdir -p "$DUMP_DIR"
            # lock using flock (safe with set -e)
            LOCK_FILE="/tmp/yardena_dump.lock"
            echo "STEP: acquire lock (flock, 120s): $LOCK_FILE"

            # exec can fail -> must be wrapped, otherwise set -e kills the script
            if ! { exec 9>"$LOCK_FILE"; }; then
              echo "❌ Cannot open lock file for writing: $LOCK_FILE"
              ls -ld /tmp || true
              exit 1
            fi

            if ! flock -w 120 9; then
              echo "❌ Could not acquire dump lock in 120s: $LOCK_FILE"
              exit 1
            fi

            trap 'flock -u 9 || true; rm -f "$LOCK_FILE" || true' EXIT
            echo "✅ Lock acquired: $LOCK_FILE"

            echo "================ DB DIAGNOSTICS ================"
            run date
            run whoami
            run pwd

            echo "---- Docker overview (top containers) ----"
            run docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}' | sed -n '1,40p'

            echo "---- MAIN DB container check ----"
            echo "MAIN_DB_CONTAINER=$MAIN_DB_CONTAINER"
            MAIN_CID="$(docker ps -qf "name=^${MAIN_DB_CONTAINER}$" || true)"
            echo "MAIN_CID=$MAIN_CID"
            [ -n "$MAIN_CID" ] || die "Main DB container not found or not running: $MAIN_DB_CONTAINER"

            echo "Main DB inspect:"
            run docker inspect "$MAIN_CID" --format 'Name={{.Name}} Image={{.Config.Image}} State={{.State.Status}} StartedAt={{.State.StartedAt}}'

            echo "Main DB readiness:"
            run docker exec "$MAIN_CID" sh -lc 'pg_isready -U "$PGUSER" -d "$PGDATABASE" -h 127.0.0.1 || pg_isready -U "$PGUSER" -d "$PGDATABASE" || true'

            echo "Main DB can connect?"
            run docker exec "$MAIN_CID" sh -lc 'psql -U "$PGUSER" -d "$PGDATABASE" -c "select now() as now, current_database() as db, current_user as usr;"'

            echo "Main DB tables count (sanity):"
            run docker exec "$MAIN_CID" sh -lc 'psql -U "$PGUSER" -d "$PGDATABASE" -tAc "select count(*) from pg_tables where schemaname not in (''pg_catalog'',''information_schema'');"'

            echo "---- DUMP file check ----"
            echo "DUMP path=$DUMP"
            [ -f "$DUMP" ] || die "Dump file does not exist: $DUMP"
            [ -s "$DUMP" ] || die "Dump file is empty (0 bytes): $DUMP"
            run ls -lah "$DUMP"
            run stat "$DUMP" || true

            echo "Try to read dump header (pg_restore -l):"
            run docker run --rm -v "$DUMP:/dump.dump:ro" postgres:17-alpine sh -lc 'pg_restore -l /dump.dump | head -n 30'

            echo "---- PR DB container check ----"
            echo "Expected PR project: $PROJECT"
            run docker ps -a --filter "label=com.docker.compose.project=$PROJECT" --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}'

            DB_CID_DBG="$(docker ps -q --filter "label=com.docker.compose.project=$PROJECT" --filter "label=com.docker.compose.service=db" | head -n1 || true)"
            echo "DB_CID(from labels)=$DB_CID_DBG"
            if [ -n "$DB_CID_DBG" ]; then
              echo "PR DB readiness:"
              run docker exec "$DB_CID_DBG" sh -lc 'pg_isready -U "$PGUSER" -d "$PGDATABASE" -h 127.0.0.1 || pg_isready -U "$PGUSER" -d "$PGDATABASE" || true'
              echo "PR DB tables BEFORE restore:"
              run docker exec "$DB_CID_DBG" sh -lc 'psql -U "$PGUSER" -d "$PGDATABASE" -tAc "select count(*) from pg_tables where schemaname not in (''pg_catalog'',''information_schema'');"' || true
            else
              echo "⚠️  PR DB container not found yet (maybe compose up is later)."
            fi

            echo "================ END DB DIAGNOSTICS ================"

            NEED_DUMP=true
            if [ -f "$DUMP" ]; then
              TS="$(stat -c %Y "$DUMP" 2>/dev/null || echo 0)"
              NOW="$(date +%s)"
              AGE_MIN=$(( (NOW - TS) / 60 ))
              if [ "$AGE_MIN" -lt "$MAX_AGE_MIN" ]; then
                NEED_DUMP=false
              fi
            fi

            if $NEED_DUMP; then
              echo "STEP: creating fresh dump (missing/older than ${MAX_AGE_MIN}m)"
              docker exec "$MAIN_DB_CONTAINER" pg_dump -U "$PGUSER" -d "$PGDATABASE" -Fc > "$DUMP"
              echo "Dump created: $(stat -c %s "$DUMP") bytes"
            else
              echo "STEP: using cached dump (fresh enough)"
              echo "Dump size: $(stat -c %s "$DUMP") bytes"
            fi
            # ---------------------------------------------------------------

            # IMPORTANT: recreate PR DB volume to avoid restore conflicts
            echo "STEP: down -v (fresh db volume)"
            docker compose -p "$PROJECT" -f "$APP_DIR/deploy/docker-compose.preview.yml" down -v --remove-orphans || true

            echo "STEP: up (build + start)"
            docker compose -p "$PROJECT" -f "$APP_DIR/deploy/docker-compose.preview.yml" up -d --build --force-recreate --remove-orphans

            DB_CID="$(docker compose -p "$PROJECT" -f "$APP_DIR/deploy/docker-compose.preview.yml" ps -q db)"
            if [ -z "${DB_CID:-}" ]; then
              echo "❌ Could not resolve DB container id" >&2
              docker compose -p "$PROJECT" -f "$APP_DIR/deploy/docker-compose.preview.yml" ps || true
              exit 1
            fi
            echo "PR DB container: $DB_CID"

            echo "STEP: wait for postgres"
            READY=false
            for i in {1..90}; do
              if docker exec "$DB_CID" pg_isready -U "$PGUSER" -d "$PGDATABASE" >/dev/null 2>&1; then
                READY=true
                break
              fi
              sleep 2
            done

            if [ "$READY" != "true" ]; then
              echo "❌ Postgres not ready in time"
              docker logs --tail=200 "$DB_CID" || true
              exit 1
            fi
            echo "Postgres ready"

            echo "STEP: restore dump into fresh PR DB"
            set +e
            cat "$DUMP" | docker exec -i "$DB_CID" pg_restore \
              -U "$PGUSER" -d "$PGDATABASE" \
              --clean --if-exists \
              --no-owner --no-privileges
            RESTORE_RC=$?
            set -e

            if [ "$RESTORE_RC" -ne 0 ]; then
              echo "❌ pg_restore failed with code $RESTORE_RC"
              echo "---- Last DB logs ----"
              docker logs --tail=200 "$DB_CID" || true
              exit 1
            fi

            echo "✅ Restore done"
            echo "✅ Preview URL: https://${PREVIEW_BASE_HOST}${PR_PATH}/"