name: Preview Deploy (PR -> dev)

on:
  pull_request:
    branches: ["dev"]
    types: [opened, synchronize, reopened]

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  deploy_preview:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy PR preview over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script_stop: true
          script: |
            set -euo pipefail
            trap 'echo "❌ FAIL at line $LINENO: $BASH_COMMAND (exit=$?)"' ERR

            echo "SHELL=$SHELL"
            echo "BASH_VERSION=${BASH_VERSION:-none}"
            echo "0=$0"

            PR_NUMBER="${{ github.event.pull_request.number }}"
            PR_SHA="${{ github.event.pull_request.head.sha }}"

            PREVIEW_BASE_HOST="linuxtest2.woki.co.il"
            PR_PATH="/pr/${PR_NUMBER}"

            APP_DIR="/opt/apps/yardena-previews/pr-${PR_NUMBER}"
            REPO_SSH="git@github.com:ValeryDevWoki/CI-CD_Testing.git"
            PROJECT="yardena-pr-${PR_NUMBER}"

            MAIN_DB_CONTAINER="yardena-db-1"
            PGUSER="yardena"
            PGDATABASE="yardena_test"

            echo "ENV CHECK: PR_NUMBER=$PR_NUMBER PREVIEW_BASE_HOST=$PREVIEW_BASE_HOST PR_PATH=$PR_PATH"
            echo "APP_DIR=$APP_DIR PROJECT=$PROJECT"

            echo "STEP: check docker access"
            docker ps >/dev/null

            echo "STEP: prepare APP_DIR"
            mkdir -p "$APP_DIR"

            if [ ! -d "$APP_DIR/.git" ]; then
              echo "STEP: clone repo"
              git clone "$REPO_SSH" "$APP_DIR"
            fi

            echo "STEP: checkout PR SHA"
            cd "$APP_DIR"
            git fetch --all
            git reset --hard "$PR_SHA"

            # backend.env copy
            if [ ! -f "$APP_DIR/deploy/backend.env" ]; then
              if [ -f "/opt/apps/yardena/deploy/backend.env" ]; then
                cp /opt/apps/yardena/deploy/backend.env "$APP_DIR/deploy/backend.env"
              else
                echo "❌ Missing $APP_DIR/deploy/backend.env and no fallback /opt/apps/yardena/deploy/backend.env" >&2
                exit 1
              fi
            fi

            export PR_NUMBER="$PR_NUMBER"
            export PREVIEW_BASE_HOST="$PREVIEW_BASE_HOST"
            export PR_PATH="$PR_PATH"

            docker network create traefik_preview_public >/dev/null 2>&1 || true

            # ---------------- DB snapshot (on-demand with cache) ----------------
            # store dump cache inside PR directory to avoid permission issues
            DUMP_DIR="$APP_DIR/.cache/db-dumps"
            DUMP="$DUMP_DIR/latest.dump"
            MAX_AGE_MIN=60

            echo "STEP: prepare dump dir: $DUMP_DIR"
            mkdir -p "$DUMP_DIR"

            # lock using mkdir (reliable in ssh-action)
            LOCK_DIR="/tmp/yardena_dump.lockdir"
            echo "STEP: acquire lock: $LOCK_DIR"
            for i in {1..120}; do
              if mkdir "$LOCK_DIR" 2>/dev/null; then
                break
              fi
              sleep 1
            done
            trap 'rmdir "$LOCK_DIR" 2>/dev/null || true' EXIT

            NEED_DUMP=true
            if [ -f "$DUMP" ]; then
              TS="$(stat -c %Y "$DUMP" 2>/dev/null || echo 0)"
              NOW="$(date +%s)"
              AGE_MIN=$(( (NOW - TS) / 60 ))
              if [ "$AGE_MIN" -lt "$MAX_AGE_MIN" ]; then
                NEED_DUMP=false
              fi
            fi

            if $NEED_DUMP; then
              echo "STEP: creating fresh dump (missing/older than ${MAX_AGE_MIN}m)"
              docker exec "$MAIN_DB_CONTAINER" pg_dump -U "$PGUSER" -d "$PGDATABASE" -Fc > "$DUMP"
              echo "Dump created: $(stat -c %s "$DUMP") bytes"
            else
              echo "STEP: using cached dump (fresh enough)"
              echo "Dump size: $(stat -c %s "$DUMP") bytes"
            fi
            # ---------------------------------------------------------------

            # IMPORTANT: recreate PR DB volume to avoid restore conflicts
            echo "STEP: down -v (fresh db volume)"
            docker compose -p "$PROJECT" -f "$APP_DIR/deploy/docker-compose.preview.yml" down -v --remove-orphans || true

            echo "STEP: up (build + start)"
            docker compose -p "$PROJECT" -f "$APP_DIR/deploy/docker-compose.preview.yml" up -d --build --force-recreate --remove-orphans

            DB_CID="$(docker compose -p "$PROJECT" -f "$APP_DIR/deploy/docker-compose.preview.yml" ps -q db)"
            if [ -z "${DB_CID:-}" ]; then
              echo "❌ Could not resolve DB container id" >&2
              docker compose -p "$PROJECT" -f "$APP_DIR/deploy/docker-compose.preview.yml" ps || true
              exit 1
            fi
            echo "PR DB container: $DB_CID"

            echo "STEP: wait for postgres"
            READY=false
            for i in {1..90}; do
              if docker exec "$DB_CID" pg_isready -U "$PGUSER" -d "$PGDATABASE" >/dev/null 2>&1; then
                READY=true
                break
              fi
              sleep 2
            done

            if [ "$READY" != "true" ]; then
              echo "❌ Postgres not ready in time"
              docker logs --tail=200 "$DB_CID" || true
              exit 1
            fi
            echo "Postgres ready"

            echo "STEP: restore dump into fresh PR DB"
            set +e
            cat "$DUMP" | docker exec -i "$DB_CID" pg_restore \
              -U "$PGUSER" -d "$PGDATABASE" \
              --clean --if-exists \
              --no-owner --no-privileges
            RESTORE_RC=$?
            set -e

            if [ "$RESTORE_RC" -ne 0 ]; then
              echo "❌ pg_restore failed with code $RESTORE_RC"
              echo "---- Last DB logs ----"
              docker logs --tail=200 "$DB_CID" || true
              exit 1
            fi

            echo "✅ Restore done"
            echo "✅ Preview URL: https://${PREVIEW_BASE_HOST}${PR_PATH}/"